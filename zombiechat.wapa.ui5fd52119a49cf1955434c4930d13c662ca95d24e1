sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/core/mvc/Controller",                                                                                                                                                                                                                                 
	"sap/ui/model/json/JSONModel",                                                                                                                                                                                                                                
	"sap/ui/core/ws/WebSocket",                                                                                                                                                                                                                                   
	"sap/m/FeedListItem",                                                                                                                                                                                                                                         
	"sap/ui/core/format/DateFormat"                                                                                                                                                                                                                               
], function (Controller, JSONModel, WebSocket, FeedListItem, DateFormat) {                                                                                                                                                                                     
	"use strict";                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
	return Controller.extend("com.abapzombie.ZombieChannelChat.controller.Chat", {                                                                                                                                                                                
                                                                                                                                                                                                                                                               
		onInit: function () {                                                                                                                                                                                                                                        
			this.getView().setModel(new JSONModel({                                                                                                                                                                                                                     
				connectedUsers: []                                                                                                                                                                                                                                         
			}), "user");                                                                                                                                                                                                                                                
			this._setChatWindowScroll();                                                                                                                                                                                                                                
			this._setMessageInputKeydown();                                                                                                                                                                                                                             
			this._setWebSocket();                                                                                                                                                                                                                                       
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_setChatWindowScroll: function () {                                                                                                                                                                                                                          
			var oChatWindow = this.byId("chatWindow");                                                                                                                                                                                                                  
			oChatWindow.addEventDelegate({                                                                                                                                                                                                                              
				onAfterRendering: function () {                                                                                                                                                                                                                            
					var aContent = oChatWindow.getContent();                                                                                                                                                                                                                  
					if (aContent.length > 0) {                                                                                                                                                                                                                                
						var $lastItem = aContent.pop().$();                                                                                                                                                                                                                      
						oChatWindow.scrollTo($lastItem.position().top + $lastItem.outerHeight());                                                                                                                                                                                
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			}, this);                                                                                                                                                                                                                                                   
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_setMessageInputKeydown: function () {                                                                                                                                                                                                                       
			this.byId("message").attachBrowserEvent("keydown", function (oEvent) {                                                                                                                                                                                      
				if (oEvent.which === 9) {                                                                                                                                                                                                                                  
					oEvent.preventDefault();                                                                                                                                                                                                                                  
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_setWebSocket: function () {                                                                                                                                                                                                                                 
			var sWSURL = "/sap/bc/apc/sap/zchat?" + jQuery.param({                                                                                                                                                                                                      
				avatar: Math.floor(Math.random() * sap.ui.core.IconPool.getIconNames().length)                                                                                                                                                                             
			});                                                                                                                                                                                                                                                         
			this._wsChat = new WebSocket(sWSURL);                                                                                                                                                                                                                       
			this._wsChat.attachMessage(this.onMessage, this);                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onSend: function () {                                                                                                                                                                                                                                        
			var oMessageInput = this.byId("message"),                                                                                                                                                                                                                   
				sText = oMessageInput.getValue();                                                                                                                                                                                                                          
			if (sText) {                                                                                                                                                                                                                                                
				this._wsChat.send(sText);                                                                                                                                                                                                                                  
			}                                                                                                                                                                                                                                                           
			oMessageInput.setValue("");                                                                                                                                                                                                                                 
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_getAvatar: function (sSender) {                                                                                                                                                                                                                             
			var aConnectedUsers = this.getView().getModel("user").getProperty("/connectedUsers"),                                                                                                                                                                       
				mSender = aConnectedUsers.find(function (user) {                                                                                                                                                                                                           
					return user.id === sSender;                                                                                                                                                                                                                               
				});                                                                                                                                                                                                                                                        
			return mSender ? "sap-icon://" + sap.ui.core.IconPool.getIconNames()[mSender.avatar] : "";                                                                                                                                                                  
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onMessage: function (oEvent) {                                                                                                                                                                                                                               
			var mData = JSON.parse(oEvent.getParameter("data")),                                                                                                                                                                                                        
				oUserModel = this.getView().getModel("user"),                                                                                                                                                                                                              
				oChatWindow = this.byId("chatWindow");                                                                                                                                                                                                                     
			if (mData.connectedUsers) {                                                                                                                                                                                                                                 
				oUserModel.setProperty("/connectedUsers", mData.connectedUsers);                                                                                                                                                                                           
			}                                                                                                                                                                                                                                                           
			if (mData.message) {                                                                                                                                                                                                                                        
				var oDateTimeInstance = DateFormat.getDateTimeInstance({                                                                                                                                                                                                   
						UTC: true                                                                                                                                                                                                                                                
					}),                                                                                                                                                                                                                                                       
					oTimestamp = oDateTimeInstance.parse(mData.message.timestamp);                                                                                                                                                                                            
				oChatWindow.addContent(new FeedListItem({                                                                                                                                                                                                                  
					icon: this._getAvatar(mData.message.sender),                                                                                                                                                                                                              
					iconActive: false,                                                                                                                                                                                                                                        
					sender: mData.message.sender,                                                                                                                                                                                                                             
					senderActive: false,                                                                                                                                                                                                                                      
					text: mData.message.text,                                                                                                                                                                                                                                 
					timestamp: oTimestamp.toLocaleString()                                                                                                                                                                                                                    
				}));                                                                                                                                                                                                                                                       
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onExit: function () {                                                                                                                                                                                                                                        
			this._wsChat.close();                                                                                                                                                                                                                                       
		}                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
	});                                                                                                                                                                                                                                                           
});                                                                                                                                                                                                                                                            