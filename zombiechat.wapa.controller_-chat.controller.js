sap.ui.define([                                                                                                                                                                                                                                                
	"sap/ui/core/mvc/Controller",                                                                                                                                                                                                                                 
	"sap/ui/model/json/JSONModel",                                                                                                                                                                                                                                
	"sap/m/FeedListItem"                                                                                                                                                                                                                                          
], function(Controller, JSONModel, FeedListItem) {                                                                                                                                                                                                             
	"use strict";                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
	return Controller.extend("com.abapzombie.chat.controller.Chat", {                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
		onInit: function() {                                                                                                                                                                                                                                         
			this.getView().setModel(new JSONModel({                                                                                                                                                                                                                     
				connectedUsers: []                                                                                                                                                                                                                                         
			}), "user");                                                                                                                                                                                                                                                
			this._setChatWindowScroll();                                                                                                                                                                                                                                
			this._setMessageInputKeydown();                                                                                                                                                                                                                             
			this._setWebSocket();                                                                                                                                                                                                                                       
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onSend: function() {                                                                                                                                                                                                                                         
			var oMessageInput = this.byId("message"),                                                                                                                                                                                                                   
				sText = oMessageInput.getValue();                                                                                                                                                                                                                          
			if (sText) {                                                                                                                                                                                                                                                
				this._wsChat.send(sText);                                                                                                                                                                                                                                  
			}                                                                                                                                                                                                                                                           
			oMessageInput.setValue("");                                                                                                                                                                                                                                 
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		onExit: function() {                                                                                                                                                                                                                                         
			this._wsChat.close();                                                                                                                                                                                                                                       
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_getAvatar: function(sSender) {                                                                                                                                                                                                                              
			var aConnectedUsers = this.getView().getModel("user").getProperty("/connectedUsers"),                                                                                                                                                                       
				aSender = jQuery.grep(aConnectedUsers, function(user) {                                                                                                                                                                                                    
					return user.id === sSender;                                                                                                                                                                                                                               
				});                                                                                                                                                                                                                                                        
			if (aSender.length === 1) {                                                                                                                                                                                                                                 
				return "sap-icon://" + sap.ui.core.IconPool.getIconNames()[aSender[0].avatar];                                                                                                                                                                             
			}                                                                                                                                                                                                                                                           
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_setMessageInputKeydown: function() {                                                                                                                                                                                                                        
			this.byId("message").attachBrowserEvent("keydown", function(oEvent) {                                                                                                                                                                                       
				if (oEvent.which === 9) {                                                                                                                                                                                                                                  
					oEvent.preventDefault();                                                                                                                                                                                                                                  
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_setChatWindowScroll: function() {                                                                                                                                                                                                                           
			var oChatWindow = this.byId("chatWindow");                                                                                                                                                                                                                  
			oChatWindow.addEventDelegate({                                                                                                                                                                                                                              
				onAfterRendering: function() {                                                                                                                                                                                                                             
					var aContent = oChatWindow.getContent();                                                                                                                                                                                                                  
					if (aContent.length > 0) {                                                                                                                                                                                                                                
						var $lastItem = jQuery.sap.byId(aContent.pop().sId);                                                                                                                                                                                                     
						oChatWindow.scrollTo($lastItem.position().top + $lastItem.outerHeight());                                                                                                                                                                                
					}                                                                                                                                                                                                                                                         
				}                                                                                                                                                                                                                                                          
			}, this);                                                                                                                                                                                                                                                   
		},                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
		_setWebSocket: function() {                                                                                                                                                                                                                                  
			var sWSURL = "ws://" + window.location.host + "/sap/bc/apc/sap/zchat?" + jQuery.param({                                                                                                                                                                     
					avatar: Math.floor(Math.random() * sap.ui.core.IconPool.getIconNames().length)                                                                                                                                                                            
				}),                                                                                                                                                                                                                                                        
				oUserModel = this.getView().getModel("user"),                                                                                                                                                                                                              
				oChatWindow = this.byId("chatWindow"),                                                                                                                                                                                                                     
				that = this;                                                                                                                                                                                                                                               
			this._wsChat = new WebSocket(sWSURL);                                                                                                                                                                                                                       
			this._wsChat.addEventListener("message", function(oEvent) {                                                                                                                                                                                                 
				var oData = JSON.parse(oEvent.data);                                                                                                                                                                                                                       
				if (oData.connectedUsers) {                                                                                                                                                                                                                                
					oUserModel.setProperty("/connectedUsers", oData.connectedUsers);                                                                                                                                                                                          
				}                                                                                                                                                                                                                                                          
				if (oData.message) {                                                                                                                                                                                                                                       
					oChatWindow.addContent(new FeedListItem({                                                                                                                                                                                                                 
						icon: that._getAvatar(oData.message.sender),                                                                                                                                                                                                             
						iconActive: false,                                                                                                                                                                                                                                       
						sender: oData.message.sender,                                                                                                                                                                                                                            
						senderActive: false,                                                                                                                                                                                                                                     
						text: oData.message.text,                                                                                                                                                                                                                                
						timestamp: (new Date(oData.message.timestamp)).toLocaleString()                                                                                                                                                                                          
					}));                                                                                                                                                                                                                                                      
				}                                                                                                                                                                                                                                                          
			});                                                                                                                                                                                                                                                         
		}                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
	});                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
});                                                                                                                                                                                                                                                            